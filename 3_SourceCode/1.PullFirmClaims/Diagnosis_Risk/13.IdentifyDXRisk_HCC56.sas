/*
*========================================================================*
* Program:   Identifying family risk from diagnosis (HCC_56)             *
*                                                                        *
* Purpose:   This code identifies non-sample individuals diagnosed 	 *
* 		with an HCC in 2007. Then, calculates the rate at which  *
*		other family members are diagnosed in next 10 years.     *
*                                                                        *
* Note: This file							 *
* Author:    Alex Hoagland	                                         *
*            Boston University				                 *
*									 *
* Created:   October, 2020		                                 *
* Updated:  		                                                 *
*========================================================================*;
*/

*Set libraries;
libname in '/projectnb2/marketscan' access=readonly;
libname out '/project/caretaking/';

/*------------------------------------------------------------------------*
 * 		ORDER OF OPERATIONS					  *
 * 0. Identify all HCC_56 claims in 2006				  *
 * 1. Identify all *new* HCC_56 claims in (2007-2010)			  *
 * 2. Keep all those who are enrolled at least 5 years post (2012-2015)   *
 * 3. Randomly sample families						  *
 * 4. Calculate rate of new diagnoses and time until dx			  *
 *------------------------------------------------------------------------*/;


/* --- 0. All Diabetics in 2006 -----------------------------------------*/; 
data out.pe_56; 
   set in.ms_o_2006(keep=enrolid dx1 dx2) in.ms_s_2006(keep=enrolid dx1 dx2);
   
   if dx1 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9') or 
      dx2 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9'); 
run; 
  
* Collapse to enrollee level; 
proc sql; 
   create table out.pe_56 as 
   select enrolid from out.pe_56
   group by enrolid; 
quit; 


/* --- 1. All NEW Diabetics in 2007-2010 -----------------------------------------*/; 
data out.new_56; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.pe_56");
   ids.definekey('enrolid');
   ids.definedone();
   end;

   set in.ms_o_2007(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2007(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2008(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2008(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2009(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2009(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2010(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2010(keep=enrolid age year dx1 dx2 svcdate fachdid);
   if ids.find()^=0;
   
   if dx1 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9') or 
      dx2 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9'); 

   if missing(fachdid) then ip=0; 
   else ip=1; 
run; 
  
* Collapse to enrollee level; 
proc sql; 
   create table out.new_56 as 
   select enrolid, age, min(year) as dx_year, min(svcdate) as dx_date, max(ip) as had_hosp from out.new_56
   group by enrolid; 
quit; 

* Make sure these new diabetics have at least a year of non-dx time before hand; 
data out.check_56;
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_56");
   ids.definekey('enrolid');
   ids.definedone();
   end;

   set in.ms_a_2006(keep=enrolid year) in.ms_a_2007(keep=enrolid year) in.ms_a_2008(keep=enrolid year) in.ms_a_2009(keep=enrolid year);
   if ids.find()^=0 then delete;
run; 

proc sql; 
   create table out.check_56 as 
   select enrolid, min(year) as fyear from out.check_56
   group by enrolid; 
quit;

data out.new_56; 
   merge out.new_56 out.check_56; 
   by enrolid;

   if dx_year - fyear < 1 then delete; 
run; 

proc delete data=out.check_56; 
run; 


/* --- 2. Keep all new diabetics enrolled at least 5 years post -----------------------------------------*/;
data out.tomerge_56; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_56");
   ids.definekey('enrolid');
   ids.definedone();
   end; 

   set in.ms_a_2012(keep=enrolid year) in.ms_a_2013(keep=enrolid year) in.ms_a_2014(keep=enrolid year) in.ms_a_2015(keep=enrolid year); 
   if ids.find()^=0 then delete; 
run; 

* Collapse to enrollee level; 
proc sql;
   create table out.tomerge_56 as 
   select enrolid, max(year) as lyear from out.tomerge_56
   group by enrolid; 
quit; 

* Merge in with out.new_56, keep those with 5 years enrollment;
data out.new_56; 
   merge out.new_56 out.tomerge_56; 

   if lyear - dx_year < 5 then delete; 
   famid = floor(enrolid/100); 
run; 

* Collapse to family ids; 
proc sql; 
   create table out.fams_56 as
   select famid from out.new_56
   group by famid; 
quit; 


/* --- 3. Draw a random sample of these families? -----------------------------------------*/;
* No need for this; 


/* --- 4. Look for secondary diagnoses within these families -----------------------------------------*/;
data out.subsequent_56; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.fams_56");
   ids.definekey('famid');
   ids.definedone();
   end; 

   set in.ms_o_2008(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2008(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2009(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2009(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2010(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2010(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2011(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2011(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2012(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2012(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2013(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2013(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2014(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2014(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2015(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2015(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2016(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2016(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2017(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2017(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2018(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2018(keep=enrolid age year dx1 dx2 svcdate fachdid);
   famid = floor(enrolid/100); 
   if ids.find()^=0 then delete;

   if dx1 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9') or 
      dx2 in: ('1361', '4460', '4461', '44620', '44621', '44629', '4463', '4464', '4466', '4467', '6960', '7101', '7103', '7104', '71120', '71121', '71122', '71123', '71124', '71125', '71126', '71127', '71128', '71129', '7140', '7141', '7142', '71430', '71431', '71432', '71433', '71481', '7200', 'L4050', 'L4051', 'L4052', 'L4053', 'L4054', 'L4059', 'M0500', 'M05011', 'M05012', 'M05019', 'M05021', 'M05022', 'M05029', 'M05031', 'M05032', 'M05039', 'M05041', 'M05042', 'M05049', 'M05051', 'M05052', 'M05059', 'M05061', 'M05062', 'M05069', 'M05071', 'M05072', 'M05079', 'M0509', 'M0510', 'M05111', 'M05112', 'M05119', 'M05121', 'M05122', 'M05129', 'M05131', 'M05132', 'M05139', 'M05141', 'M05142', 'M05149', 'M05151', 'M05152', 'M05159', 'M05161', 'M05162', 'M05169', 'M05171', 'M05172', 'M05179', 'M0519', 'M0520', 'M05211', 'M05212', 'M05219', 'M05221', 'M05222', 'M05229', 'M05231', 'M05232', 'M05239', 'M05241', 'M05242', 'M05249', 'M05251', 'M05252', 'M05259', 'M05261', 'M05262', 'M05269', 'M05271', 'M05272', 'M05279', 'M0529', 'M0530', 'M05311', 'M05312', 'M05319', 'M05321', 'M05322', 'M05329', 'M05331', 'M05332', 'M05339', 'M05341', 'M05342', 'M05349', 'M05351', 'M05352', 'M05359', 'M05361', 'M05362', 'M05369', 'M05371', 'M05372', 'M05379', 'M0539', 'M0540', 'M05411', 'M05412', 'M05419', 'M05421', 'M05422', 'M05429', 'M05431', 'M05432', 'M05439', 'M05441', 'M05442', 'M05449', 'M05451', 'M05452', 'M05459', 'M05461', 'M05462', 'M05469', 'M05471', 'M05472', 'M05479', 'M0549', 'M0550', 'M05511', 'M05512', 'M05519', 'M05521', 'M05522', 'M05529', 'M05531', 'M05532', 'M05539', 'M05541', 'M05542', 'M05549', 'M05551', 'M05552', 'M05559', 'M05561', 'M05562', 'M05569', 'M05571', 'M05572', 'M05579', 'M0559', 'M0560', 'M05611', 'M05612', 'M05619', 'M05621', 'M05622', 'M05629', 'M05631', 'M05632', 'M05639', 'M05641', 'M05642', 'M05649', 'M05651', 'M05652', 'M05659', 'M05661', 'M05662', 'M05669', 'M05671', 'M05672', 'M05679', 'M0569', 'M0570', 'M05711', 'M05712', 'M05719', 'M05721', 'M05722', 'M05729', 'M05731', 'M05732', 'M05739', 'M05741', 'M05742', 'M05749', 'M05751', 'M05752', 'M05759', 'M05761', 'M05762', 'M05769', 'M05771', 'M05772', 'M05779', 'M0579', 'M0580', 'M05811', 'M05812', 'M05819', 'M05821', 'M05822', 'M05829', 'M05831', 'M05832', 'M05839', 'M05841', 'M05842', 'M05849', 'M05851', 'M05852', 'M05859', 'M05861', 'M05862', 'M05869', 'M05871', 'M05872', 'M05879', 'M0589', 'M059', 'M0600', 'M06011', 'M06012', 'M06019', 'M06021', 'M06022', 'M06029', 'M06031', 'M06032', 'M06039', 'M06041', 'M06042', 'M06049', 'M06051', 'M06052', 'M06059', 'M06061', 'M06062', 'M06069', 'M06071', 'M06072', 'M06079', 'M0608', 'M0609', 'M061', 'M0620', 'M06211', 'M06212', 'M06219', 'M06221', 'M06222', 'M06229', 'M06231', 'M06232', 'M06239', 'M06241', 'M06242', 'M06249', 'M06251', 'M06252', 'M06259', 'M06261', 'M06262', 'M06269', 'M06271', 'M06272', 'M06279', 'M0628', 'M0629', 'M0630', 'M06311', 'M06312', 'M06319', 'M06321', 'M06322', 'M06329', 'M06331', 'M06332', 'M06339', 'M06341', 'M06342', 'M06349', 'M06351', 'M06352', 'M06359', 'M06361', 'M06362', 'M06369', 'M06371', 'M06372', 'M06379', 'M0638', 'M0639', 'M0680', 'M06811', 'M06812', 'M06819', 'M06821', 'M06822', 'M06829', 'M06831', 'M06832', 'M06839', 'M06841', 'M06842', 'M06849', 'M06851', 'M06852', 'M06859', 'M06861', 'M06862', 'M06869', 'M06871', 'M06872', 'M06879', 'M0688', 'M0689', 'M069', 'M0800', 'M08011', 'M08012', 'M08019', 'M08021', 'M08022', 'M08029', 'M08031', 'M08032', 'M08039', 'M08041', 'M08042', 'M08049', 'M08051', 'M08052', 'M08059', 'M08061', 'M08062', 'M08069', 'M08071', 'M08072', 'M08079', 'M0808', 'M0809', 'M081', 'M0820', 'M08211', 'M08212', 'M08219', 'M08221', 'M08222', 'M08229', 'M08231', 'M08232', 'M08239', 'M08241', 'M08242', 'M08249', 'M08251', 'M08252', 'M08259', 'M08261', 'M08262', 'M08269', 'M08271', 'M08272', 'M08279', 'M0828', 'M0829', 'M083', 'M0840', 'M08411', 'M08412', 'M08419', 'M08421', 'M08422', 'M08429', 'M08431', 'M08432', 'M08439', 'M08441', 'M08442', 'M08449', 'M08451', 'M08452', 'M08459', 'M08461', 'M08462', 'M08469', 'M08471', 'M08472', 'M08479', 'M0848', 'M0880', 'M08811', 'M08812', 'M08819', 'M08821', 'M08822', 'M08829', 'M08831', 'M08832', 'M08839', 'M08841', 'M08842', 'M08849', 'M08851', 'M08852', 'M08859', 'M08861', 'M08862', 'M08869', 'M08871', 'M08872', 'M08879', 'M0888', 'M0889', 'M0890', 'M08911', 'M08912', 'M08919', 'M08921', 'M08922', 'M08929', 'M08931', 'M08932', 'M08939', 'M08941', 'M08942', 'M08949', 'M08951', 'M08952', 'M08959', 'M08961', 'M08962', 'M08969', 'M08971', 'M08972', 'M08979', 'M0898', 'M0899', 'M300', 'M301', 'M302', 'M303', 'M308', 'M310', 'M311', 'M312', 'M3130', 'M3131', 'M314', 'M317', 'M3300', 'M3301', 'M3302', 'M3309', 'M3310', 'M3311', 'M3312', 'M3319', 'M3320', 'M3321', 'M3322', 'M3329', 'M3390', 'M3391', 'M3392', 'M3399', 'M340', 'M341', 'M342', 'M3481', 'M3482', 'M3483', 'M3489', 'M349', 'M352', 'M360', 'M450', 'M451', 'M452', 'M453', 'M454', 'M455', 'M456', 'M457', 'M458', 'M459', 'M488X1', 'M488X2', 'M488X3', 'M488X4', 'M488X5', 'M488X6', 'M488X7', 'M488X8', 'M488X9'); 

   if missing(fachdid) then ip=0; 
   else ip=1; 
run; 

* Remove principal diagnoses;
data out.subsequent_56; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_56");
   ids.definekey('enrolid');
   ids.definedone();
   end; 

   set out.subsequent_56; 
   if ids.find()^=0;  
run; 

* Collapse to enrollee level; 
proc sql; 
   create table out.subsequent_56 as 
   select enrolid, famid, age, min(year) as dx_year, min(svcdate) as dx_date, max(ip) as had_hosp from out.subsequent_56
   group by enrolid; 
quit; 


/* --- 5. Merge the two data sets -----------------------------------------*/;   


/* --- N. Delete some superfluous data sets -----------------------------------------*/;
proc delete data=out.tomerge_56; 
run; 

proc delete data=out.fams_56; 
run; 

