  /*
*========================================================================*
* Program:   Adults/create_cohorts_claims.sas                            *
*                                                                        *
* Purpose:   This program pulls all preventive services for adults 18-64 *
*		in the MarketScan data. 				 *
*                                                                        *
* Author:    Alex Hoagland/Paul Shafer                                   *
*            Boston University				                 *
*                                                                        *
* Created:   June 16, 2020	                                         *
* Updated:  		                                                 *
*========================================================================*;
*/
   
*Set libraries;
libname in '/projectnb2/marketscan' access=readonly;
libname out '/project/caretaking/';

proc import out=out.allfamilies
    datafile="AllFamilies.csv"
    dbms=csv;
run; 
        
/*-------------------------*
* Create OUTPATIENT sample *
*--------------------------*/;
       
*Pull and save all outpatient preventive claims; 
data out.outpatient2006(compress=yes); 
   if _N_=1 then do;
   declare hash ids(dataset:"out.allfamilies");
   ids.definekey('famid');
   ids.definedone();
   end;
        set in.ms_o_2006(keep=enrolid year dx: proc: netpay pay cob copay coins ded: svc: std: ntwkprov); 
   famid = floor(enrolid/100); 
   if ids.find()^=0 then delete;

   /* Plan Radiography */; 
   if (proc1 in: ('72010', '72020', '72100', '72110', '72114', '72120', '72200', '72202', '72220', '74018', '73140', '71101', '72100', '74019', '73630',
                  '71111', '72110', '74021', '73090', '72220', '72114', '73050', '73130', '71130', '73610', '73650', '73010', '72120', '73523', '73030',
                  '72081', '71045', '73502', '72202', '72082', '71046', '73060', '70220', '72072', '71047', '74400', '70260', '71120', '71048', '73562',
                  '70360', '73590', '73000', '70110', '72040', '70330', '73080', '70160', '72050', '73660', '70030', '70200', '73110', '70150', '77075',
                  '72052', '73552', '72170', '76700', '93306', '76802', '76775', '76705', '93000', '76805', '76870', '93880', '93925', '76801', '93351',
                  '76857', '93926', '76817', '76830', '76641', '93970', '76856', '76642', '93971', '76604', '76882', '76536', '76770') and 
      (substr(dx1,1,3) in: ('460', '461', '462', '463', '464', '465', '466', 'J01', 'J02', 'J03', 'J04', 'J05', 'J06', '724', '846', '847', 'M54', 'S23', 'S33') or
      substr(dx2,1,3) in: ('460', '461', '462', '463', '464', '465', '466', 'J01', 'J02', 'J03', 'J04', 'J05', 'J06', '724', '846', '847', 'M54', 'S23', 'S33') or
      substr(dx3,1,3) in: ('460', '461', '462', '463', '464', '465', '466', 'J01', 'J02', 'J03', 'J04', 'J05', 'J06', '724', '846', '847', 'M54', 'S23', 'S33') or
      substr(dx4,1,3) in: ('460', '461', '462', '463', '464', '465', '466', 'J01', 'J02', 'J03', 'J04', 'J05', 'J06', '724', '846', '847', 'M54', 'S23', 'S33')))
    then lvs_r = 1; 

   /* Advanced imaging */; 
   if (proc1 in: ('72141', '72142', '72146', '72147', '72148', '72149', '72156', '72158', '72131', '72132', '72133', '74177', '74177', '70486', '70486',
                  '74178', '73701', '70491', '76380', '74176', '73700', '70490', '72126', '74160', '73201', '70481', '72125', '74150', '73200', '70480',
                  '72132', '74170', '70460', '70482', '72131', '71260', '70450', '72193', '72129', '71250', '70470', '72192', '72128', '71270', '70487',
                  '72194', '74176', '75571', '74174', '70496', '75574', '74175', '71275', '70498', '75572', '74181', '73720', '73221', '72197', '76377', 
                  '74183', '70551', '73721', '73223', '72141', '70553', '72156', '77047', '73723', '74183', '72197', '72148', '77049', '72158', '71550',
                  '73218', '70540', '72146', '71552', '70543', '72157', '73718', '73220', '72195', '70336', '72197', '78608', ',78816', '78816', '78815',
                  '78608', '70450', '78816', '74177', '71260', '78815', '71260', '74177') and 
      (substr(dx1,1,3) in: ('724', '846', '847', 'M54', 'S23', 'S33', 'R51', '784') or
       substr(dx2,1,3) in: ('724', '846', '847', 'M54', 'S23', 'S33', 'R51', '784') or
       substr(dx3,1,3) in: ('724', '846', '847', 'M54', 'S23', 'S33', 'R51', '784') or
       substr(dx4,1,3) in: ('724', '846', '847', 'M54', 'S23', 'S33', 'R51', '784')))
     then lvs_ai = 1; 

   if lvs_r = 1 or lvs_ai = 1; 
run;

*Export claims; 
proc export data=out.outpatient2006
    outfile = "/project/caretaking/AllFamilies_LowValue_2006.dta"
    dbms=stata
    replace;
run; 

/*-----------------*
* Delete SAS data *
*------------------*/; 

proc delete data=out.outpatient2006;
run; 

