  /*
*========================================================================*
* Program:   Adults/create_cohorts_claims.sas                            *
*                                                                        *
* Purpose:   This program pulls all preventive services for adults 18-64 *
*		in the MarketScan data. 				 *
*                                                                        *
* Author:    Alex Hoagland/Paul Shafer                                   *
*            Boston University				                 *
*                                                                        *
* Created:   June 16, 2020	                                         *
* Updated:  		                                                 *
*========================================================================*;
*/
   
*Set libraries;
libname in '/projectnb2/marketscan' access=readonly;
libname out '/project/caretaking/';

proc import out=out.working_DDD_allaffectedenrollees
    datafile="working_DDD_allaffectedenrollees.csv"
    dbms=csv;
run; 
        
/*-------------------------*
* Create OUTPATIENT sample *
*--------------------------*/;
       
*Pull and save all outpatient preventive claims; 
data out.diabetes_screening2006(compress=yes); 
   if _N_=1 then do;
   declare hash ids(dataset:"out.working_DDD_allaffectedenrollees");
   ids.definekey('enrolid');
   ids.definedone();
   end;
        set in.ms_o_2006(keep=enrolid year svcdate dx1 dx2 proc1); 
   if ids.find()^=0 then delete;

   /*Diabetes Screening*/;
   if ((dx1 in: ('V700', 'V771', 'Z0000', 'Z0001', 'Z131', '4010', '4011', '4019', 'I10', '40200', '40201', '40210', '40211', '40290', '40291', 'I110', 'I119', '40300', '40301', '40310', '40311', '40390', '49391', 'I120', 'I129', '40400', '40401', '40402', '40403', '40410', '40411', '40412', '40413', '40490', '40491', '40492', '40493', 'I130', 'I1310', 'I1311', 'I132', '40501', '40509', '40511', '40519', '40591', '40599', 'I150', 'I151', 'I152', 'I158', 'I159', 'N262', '64201', '64203', '64204', '64211', '64213', '64214', '64221', '64223', '64224', '64230', '64231', '64233', '64234', '64291', '64293', '94294', 'O10011', 'O10012', 'O10013', 'O10019', 'O1002', 'O1003', 'O10111', 'O10112', 'O10113', 'O10119', 'O1012', 'O1013', 'O10211', 'O10212', 'O10213', 'O10219', 'O1022', 'O1023', 'O10311', 'O10312', 'O10313', 'O10319', 'O1032', 'O1033', 'O10411', 'O10412', 'O10413', 'O10419', 'O1042', 'O1043', 'O10911', 'O10912', 'O10913', 'O10919', 'O1092', 'O1093', 'O111', 'O112', 'O113', 'O119', 'O131', 'O132', 'O139', 'O161', 'O162', 'O163', 'O169') or 
       dx2 in: ('V700', 'V771', 'Z0000', 'Z0001', 'Z131', '4010', '4011', '4019', 'I10', '40200', '40201', '40210', '40211', '40290', '40291', 'I110', 'I119', '40300', '40301', '40310', '40311', '40390', '49391', 'I120', 'I129', '40400', '40401', '40402', '40403', '40410', '40411', '40412', '40413', '40490', '40491', '40492', '40493', 'I130', 'I1310', 'I1311', 'I132', '40501', '40509', '40511', '40519', '40591', '40599', 'I150', 'I151', 'I152', 'I158', 'I159', 'N262', '64201', '64203', '64204', '64211', '64213', '64214', '64221', '64223', '64224', '64230', '64231', '64233', '64234', '64291', '64293', '94294', 'O10011', 'O10012', 'O10013', 'O10019', 'O1002', 'O1003', 'O10111', 'O10112', 'O10113', 'O10119', 'O1012', 'O1013', 'O10211', 'O10212', 'O10213', 'O10219', 'O1022', 'O1023', 'O10311', 'O10312', 'O10313', 'O10319', 'O1032', 'O1033', 'O10411', 'O10412', 'O10413', 'O10419', 'O1042', 'O1043', 'O10911', 'O10912', 'O10913', 'O10919', 'O1092', 'O1093', 'O111', 'O112', 'O113', 'O119', 'O131', 'O132', 'O139', 'O161', 'O162', 'O163', 'O169')) and 
       proc1 in: ('36415', '36416', '82947', '82948', '82950', '82951', '82952', '83036'));
run;

*Export claims; 
proc export data=out.diabetes_screening2006
    outfile = "/project/caretaking/diabetes_screening_2006.dta"
    dbms=stata
    replace;
run; 

/*-----------------*
* Delete SAS data *
*------------------*/; 

proc delete data=out.diabetes_screening2006;
run; 

