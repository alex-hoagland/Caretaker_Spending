/*
*========================================================================*
* Program:   Identifying family risk from diagnosis (HCC_217)             *
*                                                                        *
* Purpose:   This code identifies non-sample individuals diagnosed 	 *
* 		with an HCC in 2007. Then, calculates the rate at which  *
*		other family members are diagnosed in next 10 years.     *
*                                                                        *
* Note: This file							 *
* Author:    Alex Hoagland	                                         *
*            Boston University				                 *
*									 *
* Created:   October, 2020		                                 *
* Updated:  		                                                 *
*========================================================================*;
*/

*Set libraries;
libname in '/projectnb2/marketscan' access=readonly;
libname out '/project/caretaking/';

/*------------------------------------------------------------------------*
 * 		ORDER OF OPERATIONS					  *
 * 0. Identify all HCC_217 claims in 2006				  *
 * 1. Identify all *new* HCC_217 claims in (2007-2010)			  *
 * 2. Keep all those who are enrolled at least 5 years post (2012-2015)   *
 * 3. Randomly sample families						  *
 * 4. Calculate rate of new diagnoses and time until dx			  *
 *------------------------------------------------------------------------*/;


/* --- 0. All Diabetics in 2006 -----------------------------------------*/; 
data out.pe_217; 
   set in.ms_o_2006(keep=enrolid dx1 dx2) in.ms_s_2006(keep=enrolid dx1 dx2);
   
   if dx1 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075') or 
      dx2 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075'); 
run; 
  
* Collapse to enrollee level; 
proc sql; 
   create table out.pe_217 as 
   select enrolid from out.pe_217
   group by enrolid; 
quit; 


/* --- 1. All NEW Diabetics in 2007-2010 -----------------------------------------*/; 
data out.new_217; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.pe_217");
   ids.definekey('enrolid');
   ids.definedone();
   end;

   set in.ms_o_2007(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2007(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2008(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2008(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2009(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2009(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2010(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2010(keep=enrolid age year dx1 dx2 svcdate fachdid);
   if ids.find()^=0;
   
   if dx1 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075') or 
      dx2 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075'); 

   if missing(fachdid) then ip=0; 
   else ip=1; 
run; 
  
* Collapse to enrollee level; 
proc sql; 
   create table out.new_217 as 
   select enrolid, age, min(year) as dx_year, min(svcdate) as dx_date, max(ip) as had_hosp from out.new_217
   group by enrolid; 
quit; 

* Make sure these new diabetics have at least a year of non-dx time before hand; 
data out.check_217;
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_217");
   ids.definekey('enrolid');
   ids.definedone();
   end;

   set in.ms_a_2006(keep=enrolid year) in.ms_a_2007(keep=enrolid year) in.ms_a_2008(keep=enrolid year) in.ms_a_2009(keep=enrolid year);
   if ids.find()^=0 then delete;
run; 

proc sql; 
   create table out.check_217 as 
   select enrolid, min(year) as fyear from out.check_217
   group by enrolid; 
quit;

data out.new_217; 
   merge out.new_217 out.check_217; 
   by enrolid;

   if dx_year - fyear < 1 then delete; 
run; 

proc delete data=out.check_217; 
run; 


/* --- 2. Keep all new diabetics enrolled at least 5 years post -----------------------------------------*/;
data out.tomerge_217; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_217");
   ids.definekey('enrolid');
   ids.definedone();
   end; 

   set in.ms_a_2012(keep=enrolid year) in.ms_a_2013(keep=enrolid year) in.ms_a_2014(keep=enrolid year) in.ms_a_2015(keep=enrolid year); 
   if ids.find()^=0 then delete; 
run; 

* Collapse to enrollee level; 
proc sql;
   create table out.tomerge_217 as 
   select enrolid, max(year) as lyear from out.tomerge_217
   group by enrolid; 
quit; 

* Merge in with out.new_217, keep those with 5 years enrollment;
data out.new_217; 
   merge out.new_217 out.tomerge_217; 

   if lyear - dx_year < 5 then delete; 
   famid = floor(enrolid/100); 
run; 

* Collapse to family ids; 
proc sql; 
   create table out.fams_217 as
   select famid from out.new_217
   group by famid; 
quit; 


/* --- 3. Draw a random sample of these families? -----------------------------------------*/;
* No need for this; 


/* --- 4. Look for secondary diagnoses within these families -----------------------------------------*/;
data out.subsequent_217; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.fams_217");
   ids.definekey('famid');
   ids.definedone();
   end; 

   set in.ms_o_2008(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2008(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2009(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2009(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2010(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2010(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2011(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2011(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2012(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2012(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2013(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2013(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2014(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2014(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2015(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2015(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2016(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2016(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2017(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2017(keep=enrolid age year dx1 dx2 svcdate fachdid)
       in.ms_o_2018(keep=enrolid age year dx1 dx2 svcdate fachdid) in.ms_s_2018(keep=enrolid age year dx1 dx2 svcdate fachdid);
   famid = floor(enrolid/100); 
   if ids.find()^=0 then delete;

   if dx1 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075') or 
      dx2 in: ('4540', '4542', '45911', '45913', '45931', '45933', '68601', '70710', '70711', '70712', '70713', '70714', '70715', '70719', '7078', '7079', 'I83001', 'I83002', 'I83003', 'I83004', 'I83005', 'I83008', 'I83009', 'I83011', 'I83012', 'I83013', 'I83014', 'I83015', 'I83018', 'I83019', 'I83021', 'I83022', 'I83023', 'I83024', 'I83025', 'I83028', 'I83029', 'I83201', 'I83202', 'I83203', 'I83204', 'I83205', 'I83208', 'I83209', 'I83211', 'I83212', 'I83213', 'I83214', 'I83215', 'I83218', 'I83219', 'I83221', 'I83222', 'I83223', 'I83224', 'I83225', 'I83228', 'I83229', 'I87011', 'I87012', 'I87013', 'I87019', 'I87031', 'I87032', 'I87033', 'I87039', 'I87311', 'I87312', 'I87313', 'I87319', 'I87331', 'I87332', 'I87333', 'I87339', 'L88', 'L97101', 'L97102', 'L97103', 'L97104', 'L97109', 'L97111', 'L97112', 'L97113', 'L97114', 'L97119', 'L97121', 'L97122', 'L97123', 'L97124', 'L97129', 'L97201', 'L97202', 'L97203', 'L97204', 'L97209', 'L97211', 'L97212', 'L97213', 'L97214', 'L97219', 'L97221', 'L97222', 'L97223', 'L97224', 'L97229', 'L97301', 'L97302', 'L97303', 'L97304', 'L97309', 'L97311', 'L97312', 'L97313', 'L97314', 'L97319', 'L97321', 'L97322', 'L97323', 'L97324', 'L97329', 'L97401', 'L97402', 'L97403', 'L97404', 'L97409', 'L97411', 'L97412', 'L97413', 'L97414', 'L97419', 'L97421', 'L97422', 'L97423', 'L97424', 'L97429', 'L97501', 'L97502', 'L97503', 'L97504', 'L97509', 'L97511', 'L97512', 'L97513', 'L97514', 'L97519', 'L97521', 'L97522', 'L97523', 'L97524', 'L97529', 'L97801', 'L97802', 'L97803', 'L97804', 'L97809', 'L97811', 'L97812', 'L97813', 'L97814', 'L97819', 'L97821', 'L97822', 'L97823', 'L97824', 'L97829', 'L97901', 'L97902', 'L97903', 'L97904', 'L97909', 'L97911', 'L97912', 'L97913', 'L97914', 'L97919', 'L97921', 'L97922', 'L97923', 'L97924', 'L97929', 'L98411', 'L98412', 'L98413', 'L98414', 'L98419', 'L98421', 'L98422', 'L98423', 'L98424', 'L98429', 'L98491', 'L98492', 'L98493', 'L98494', 'L98499', 'I70231', 'I70232', 'I70233', 'I70234', 'I70235', 'I70238', 'I70239', 'I70241', 'I70242', 'I70243', 'I70244', 'I70245', 'I70248', 'I70249', 'I7025', 'I70331', 'I70332', 'I70333', 'I70334', 'I70335', 'I70338', 'I70339', 'I70341', 'I70342', 'I70343', 'I70344', 'I70345', 'I70348', 'I70349', 'I7035', 'I70431', 'I70432', 'I70433', 'I70434', 'I70435', 'I70438', 'I70439', 'I70441', 'I70442', 'I70443', 'I70444', 'I70445', 'I70448', 'I70449', 'I7045', 'I70531', 'I70532', 'I70533', 'I70534', 'I70535', 'I70538', 'I70539', 'I70541', 'I70542', 'I70543', 'I70544', 'I70545', 'I70548', 'I70549', 'I7055', 'I70631', 'I70632', 'I70633', 'I70634', 'I70635', 'I70638', 'I70639', 'I70641', 'I70642', 'I70643', 'I70644', 'I70645', 'I70648', 'I70649', 'I7065', 'I70731', 'I70732', 'I70733', 'I70734', 'I70735', 'I70738', 'I70739', 'I70741', 'I70742', 'I70743', 'I70744', 'I70745', 'I70748', 'I70749', 'I7075'); 

   if missing(fachdid) then ip=0; 
   else ip=1; 
run; 

* Remove principal diagnoses;
data out.subsequent_217; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.new_217");
   ids.definekey('enrolid');
   ids.definedone();
   end; 

   set out.subsequent_217; 
   if ids.find()^=0;  
run; 

* Collapse to enrollee level; 
proc sql; 
   create table out.subsequent_217 as 
   select enrolid, famid, age, min(year) as dx_year, min(svcdate) as dx_date, max(ip) as had_hosp from out.subsequent_217
   group by enrolid; 
quit; 


/* --- 5. Merge the two data sets -----------------------------------------*/;   


/* --- N. Delete some superfluous data sets -----------------------------------------*/;
proc delete data=out.tomerge_217; 
run; 

proc delete data=out.fams_217; 
run; 

