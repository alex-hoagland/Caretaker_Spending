/*
*========================================================================*
* Program:   Identifying family risk from diagnosis 		             *
*                                                                        *
* Purpose:   This code identifies non-sample individuals diagnosed 	 *
* 		with an HCC in 2007. Then, calculates the rate at which  *
*		other family members are diagnosed in next 10 years.     *
*                                                                        *
* Note: This file							 *
* Author:    Alex Hoagland	                                         *
*            Boston University				                 *
*									 *
* Created:   October, 2020		                                 *
* Updated:  		                                                 *
*========================================================================*;
*/

*Set libraries;
libname in '/projectnb2/marketscan' access=readonly;
libname out '/project/caretaking/IdentifyPHat/';

/*------------------------------------------------------------------------*
 * 		ORDER OF OPERATIONS					  *
 * 0. Identify all with HCC  claims in 2008-2018			  *
 * 1. Pull enrollment files for all families in (0.)			  *
 * 2. The rest is done in stata						  *
 *------------------------------------------------------------------------*/;


/* --- 0. All Claims, 2008 - 2018 -----------------------------------------*/; 
data out.allclaims_hcc88_2008; 
   set in.ms_o_2008(keep=enrolid age sex year dx1 dx2 svcdate) in.ms_s_2008(keep=enrolid age sex year dx1 dx2 svcdate);
   
   if dx1 in: ('F3010', 'F3011', 'F3012', 'F3013', 'F302', 'F303', 'F304', 'F308', 'F309', 'F310', 'F3110', 'F3111', 'F3112', 'F3113', 'F312', 'F3130', 'F3131', 'F3132', 'F314', 'F315', 'F3160', 'F3161', 'F3162', 'F3163', 'F3164', 'F3170', 'F3171', 'F3172', 'F3173', 'F3174', 'F3175', 'F3176', 'F3177', 'F3178', 'F3181', 'F3189', 'F319', 'F322', 'F323', 'F332', 'F333', 'T1491', 'T360X2A', 'T360X2S', 'T361X2A', 'T361X2S', 'T362X2A', 'T362X2S', 'T363X2A', 'T363X2S', 'T364X2A', 'T364X2S', 'T365X2A', 'T365X2S', 'T366X2A', 'T366X2S', 'T367X2A', 'T367X2S', 'T368X2A', 'T368X2S', 'T3692XA', 'T3692XS', 'T370X2A', 'T370X2S', 'T371X2A', 'T371X2S', 'T372X2A', 'T372X2S', 'T373X2A', 'T373X2S', 'T374X2A', 'T374X2S', 'T375X2A', 'T375X2S', 'T378X2A', 'T378X2S', 'T3792XA', 'T3792XS', 'T380X2A', 'T380X2S', 'T381X2A', 'T381X2S', 'T382X2A', 'T382X2S', 'T383X2A', 'T383X2S', 'T384X2A', 'T384X2S', 'T385X2A', 'T385X2S', 'T386X2A', 'T386X2S', 'T387X2A', 'T387X2S', 'T38802A', 'T38802S', 'T38812A', 'T38812S', 'T38892A', 'T38892S', 'T38902A', 'T38902S', 'T38992A', 'T38992S', 'T39012A', 'T39012S', 'T39092A', 'T39092S', 'T391X2A', 'T391X2S', 'T392X2A', 'T392X2S', 'T39312A', 'T39312S', 'T39392A', 'T39392S', 'T394X2A', 'T394X2S', 'T398X2A', 'T398X2S', 'T3992XA', 'T3992XS', 'T400X2A', 'T400X2S', 'T401X2A', 'T401X2S', 'T402X2A', 'T402X2S', 'T403X2A', 'T403X2S', 'T404X2A', 'T404X2S', 'T405X2A', 'T405X2S', 'T40602A', 'T40602S', 'T40692A', 'T40692S', 'T407X2A', 'T407X2S', 'T408X2A', 'T408X2S', 'T40902A', 'T40902S', 'T40992A', 'T40992S', 'T410X2A', 'T410X2S', 'T411X2A', 'T411X2S', 'T41202A', 'T41202S', 'T41292A', 'T41292S', 'T413X2A', 'T413X2S', 'T4142XA', 'T4142XS', 'T415X2A', 'T415X2S', 'T420X2A', 'T420X2S', 'T421X2A', 'T421X2S', 'T422X2A', 'T422X2S', 'T423X2A', 'T423X2S', 'T424X2A', 'T424X2S', 'T425X2A', 'T425X2S', 'T426X2A', 'T426X2S', 'T4272XA', 'T4272XS', 'T428X2A', 'T428X2S', 'T43012A', 'T43012S', 'T43022A', 'T43022S', 'T431X2A', 'T431X2S', 'T43202A', 'T43202S', 'T43212A', 'T43212S', 'T43222A', 'T43222S', 'T43292A', 'T43292S', 'T433X2A', 'T433X2S', 'T434X2A', 'T434X2S', 'T43502A', 'T43502S', 'T43592A', 'T43592S', 'T43602A', 'T43602S', 'T43612A', 'T43612S', 'T43622A', 'T43622S', 'T43632A', 'T43632S', 'T43692A', 'T43692S', 'T438X2A', 'T438X2S', 'T4392XA', 'T4392XS', 'T440X2A', 'T440X2S', 'T441X2A', 'T441X2S', 'T442X2A', 'T442X2S', 'T443X2A', 'T443X2S', 'T444X2A', 'T444X2S', 'T445X2A', 'T445X2S', 'T446X2A', 'T446X2S', 'T447X2A', 'T447X2S', 'T448X2A', 'T448X2S', 'T44902A', 'T44902S', 'T44992A', 'T44992S', 'T450X2A', 'T450X2S', 'T451X2A', 'T451X2S', 'T452X2A', 'T452X2S', 'T453X2A', 'T453X2S', 'T454X2A', 'T454X2S', 'T45512A', 'T45512S', 'T45522A', 'T45522S', 'T45602A', 'T45602S', 'T45612A', 'T45612S', 'T45622A', 'T45622S', 'T45692A', 'T45692S', 'T457X2A', 'T457X2S', 'T458X2A', 'T458X2S', 'T4592XA', 'T4592XS', 'T460X2A', 'T460X2S', 'T461X2A', 'T461X2S', 'T462X2A', 'T462X2S', 'T463X2A', 'T463X2S', 'T464X2A', 'T464X2S', 'T465X2A', 'T465X2S', 'T466X2A', 'T466X2S', 'T467X2A', 'T467X2S', 'T468X2A', 'T468X2S', 'T46902A', 'T46902S', 'T46992A', 'T46992S', 'T470X2A', 'T470X2S', 'T471X2A', 'T471X2S', 'T472X2A', 'T472X2S', 'T473X2A', 'T473X2S', 'T474X2A', 'T474X2S', 'T475X2A', 'T475X2S', 'T476X2A', 'T476X2S', 'T477X2A', 'T477X2S', 'T478X2A', 'T478X2S', 'T4792XA', 'T4792XS', 'T480X2A', 'T480X2S', 'T481X2A', 'T481X2S', 'T48202A', 'T48202S', 'T48292A', 'T48292S', 'T483X2A', 'T483X2S', 'T484X2A', 'T484X2S', 'T485X2A', 'T485X2S', 'T486X2A', 'T486X2S', 'T48902A', 'T48902S', 'T48992A', 'T48992S', 'T490X2A', 'T490X2S', 'T491X2A', 'T491X2S', 'T492X2A', 'T492X2S', 'T493X2A', 'T493X2S', 'T494X2A', 'T494X2S', 'T495X2A', 'T495X2S', 'T496X2A', 'T496X2S', 'T497X2A', 'T497X2S', 'T498X2A', 'T498X2S', 'T4992XA', 'T4992XS', 'T500X2A', 'T500X2S', 'T501X2A', 'T501X2S', 'T502X2A', 'T502X2S', 'T503X2A', 'T503X2S', 'T504X2A', 'T504X2S', 'T505X2A', 'T505X2S', 'T506X2A', 'T506X2S', 'T507X2A', 'T507X2S', 'T508X2A', 'T508X2S', 'T50902A', 'T50902S', 'T50992A', 'T50992S', 'T50A12A', 'T50A12S', 'T50A22A', 'T50A22S', 'T50A92A', 'T50A92S', 'T50B12A', 'T50B12S', 'T50B92A', 'T50B92S', 'T50Z12A', 'T50Z12S', 'T50Z92A', 'T50Z92S', 'T510X2A', 'T510X2S', 'T511X2A', 'T511X2S', 'T512X2A', 'T512X2S', 'T513X2A', 'T513X2S', 'T518X2A', 'T518X2S', 'T5192XA', 'T5192XS', 'T520X2A', 'T520X2S', 'T521X2A', 'T521X2S', 'T522X2A', 'T522X2S', 'T523X2A', 'T523X2S', 'T524X2A', 'T524X2S', 'T528X2A', 'T528X2S', 'T5292XA', 'T5292XS', 'T530X2A', 'T530X2S', 'T531X2A', 'T531X2S', 'T532X2A', 'T532X2S', 'T533X2A', 'T533X2S', 'T534X2A', 'T534X2S', 'T535X2A', 'T535X2S', 'T536X2A', 'T536X2S', 'T537X2A', 'T537X2S', 'T5392XA', 'T5392XS', 'T540X2A', 'T540X2S', 'T541X2A', 'T541X2S', 'T542X2A', 'T542X2S', 'T543X2A', 'T543X2S', 'T5492XA', 'T5492XS', 'T550X2A', 'T550X2S', 'T551X2A', 'T551X2S', 'T560X2A', 'T560X2S', 'T561X2A', 'T561X2S', 'T562X2A', 'T562X2S', 'T563X2A', 'T563X2S', 'T564X2A', 'T564X2S', 'T565X2A', 'T565X2S', 'T566X2A', 'T566X2S', 'T567X2A', 'T567X2S', 'T56812A', 'T56812S', 'T56892A', 'T56892S', 'T5692XA', 'T5692XS', 'T570X2A', 'T570X2S', 'T571X2A', 'T571X2S', 'T572X2A', 'T572X2S', 'T573X2A', 'T573X2S', 'T578X2A', 'T578X2S', 'T5792XA', 'T5792XS', 'T5802XA', 'T5802XS', 'T5812XA', 'T5812XS', 'T582X2A', 'T582X2S', 'T588X2A', 'T588X2S', 'T5892XA', 'T5892XS', 'T590X2A', 'T590X2S', 'T591X2A', 'T591X2S', 'T592X2A', 'T592X2S', 'T593X2A', 'T593X2S', 'T594X2A', 'T594X2S', 'T595X2A', 'T595X2S', 'T596X2A', 'T596X2S', 'T597X2A', 'T597X2S', 'T59812A', 'T59812S', 'T59892A', 'T59892S', 'T5992XA', 'T5992XS', 'T600X2A', 'T600X2S', 'T601X2A', 'T601X2S', 'T602X2A', 'T602X2S', 'T603X2A', 'T603X2S', 'T604X2A', 'T604X2S', 'T608X2A', 'T608X2S', 'T6092XA', 'T6092XS', 'T6102XA', 'T6102XS', 'T6112XA', 'T6112XS', 'T61772A', 'T61772S', 'T61782A', 'T61782S', 'T618X2A', 'T618X2S', 'T6192XA', 'T6192XS', 'T620X2A', 'T620X2S', 'T621X2A', 'T621X2S', 'T622X2A', 'T622X2S', 'T628X2A', 'T628X2S', 'T6292XA', 'T6292XS', 'T63002A', 'T63002S', 'T63012A', 'T63012S', 'T63022A', 'T63022S', 'T63032A', 'T63032S', 'T63042A', 'T63042S', 'T63062A', 'T63062S', 'T63072A', 'T63072S', 'T63082A', 'T63082S', 'T63092A', 'T63092S', 'T63112A', 'T63112S', 'T63122A', 'T63122S', 'T63192A', 'T63192S', 'T632X2A', 'T632X2S', 'T63302A', 'T63302S', 'T63312A', 'T63312S', 'T63322A', 'T63322S', 'T63332A', 'T63332S', 'T63392A', 'T63392S', 'T63412A', 'T63412S', 'T63422A', 'T63422S', 'T63432A', 'T63432S', 'T63442A', 'T63442S', 'T63452A', 'T63452S', 'T63462A', 'T63462S', 'T63482A', 'T63482S', 'T63512A', 'T63512S', 'T63592A', 'T63592S', 'T63612A', 'T63612S', 'T63622A', 'T63622S', 'T63632A', 'T63632S', 'T63692A', 'T63692S', 'T63712A', 'T63712S', 'T63792A', 'T63792S', 'T63812A', 'T63812S', 'T63822A', 'T63822S', 'T63832A', 'T63832S', 'T63892A', 'T63892S', 'T6392XA', 'T6392XS', 'T6402XA', 'T6402XS', 'T6482XA', 'T6482XS', 'T650X2A', 'T650X2S', 'T651X2A', 'T651X2S', 'T65212A', 'T65212S', 'T65222A', 'T65222S', 'T65292A', 'T65292S', 'T653X2A', 'T653X2S', 'T654X2A', 'T654X2S', 'T655X2A', 'T655X2S', 'T656X2A', 'T656X2S', 'T65812A', 'T65812S', 'T65822A', 'T65822S', 'T65832A', 'T65832S', 'T65892A', 'T65892S', 'T6592XA', 'T6592XS', 'T71112A', 'T71112S', 'T71122A', 'T71122S', 'T71132A', 'T71132S', 'T71152A', 'T71152S', 'T71162A', 'T71162S', 'T71192A', 'T71192S', 'T71222A', 'T71222S', 'T71232A', 'T71232S', 'X710XXA', 'X710XXD', 'X710XXS', 'X711XXA', 'X711XXD', 'X711XXS', 'X712XXA', 'X712XXD', 'X712XXS', 'X713XXA', 'X713XXD', 'X713XXS', 'X718XXA', 'X718XXD', 'X718XXS', 'X719XXA', 'X719XXD', 'X719XXS', 'X72XXXA', 'X72XXXD', 'X72XXXS', 'X730XXA', 'X730XXD', 'X730XXS', 'X731XXA', 'X731XXD', 'X731XXS', 'X732XXA', 'X732XXD', 'X732XXS', 'X738XXA', 'X738XXD', 'X738XXS', 'X739XXA', 'X739XXD', 'X739XXS', 'X7401XA', 'X7401XD', 'X7401XS', 'X7402XA', 'X7402XD', 'X7402XS', 'X7409XA', 'X7409XD', 'X7409XS', 'X748XXA', 'X748XXD', 'X748XXS', 'X749XXA', 'X749XXD', 'X749XXS', 'X75XXXA', 'X75XXXD', 'X75XXXS', 'X76XXXA', 'X76XXXD', 'X76XXXS', 'X770XXA', 'X770XXD', 'X770XXS', 'X771XXA', 'X771XXD', 'X771XXS', 'X772XXA', 'X772XXD', 'X772XXS', 'X773XXA', 'X773XXD', 'X773XXS', 'X778XXA', 'X778XXD', 'X778XXS', 'X779XXA', 'X779XXD', 'X779XXS', 'X780XXA', 'X780XXD', 'X780XXS', 'X781XXA', 'X781XXD', 'X781XXS', 'X782XXA', 'X782XXD', 'X782XXS', 'X788XXA', 'X788XXD', 'X788XXS', 'X789XXA', 'X789XXD', 'X789XXS', 'X79XXXA', 'X79XXXD', 'X79XXXS', 'X80XXXA', 'X80XXXD', 'X80XXXS', 'X810XXA', 'X810XXD', 'X810XXS', 'X811XXA', 'X811XXD', 'X811XXS', 'X818XXA', 'X818XXD', 'X818XXS', 'X820XXA', 'X820XXD', 'X820XXS', 'X821XXA', 'X821XXD', 'X821XXS', 'X822XXA', 'X822XXD', 'X822XXS', 'X828XXA', 'X828XXD', 'X828XXS', 'X830XXA', 'X830XXD', 'X830XXS', 'X831XXA', 'X831XXD', 'X831XXS', 'X832XXA', 'X832XXD', 'X832XXS', 'X838XXA', 'X838XXD', 'X838XXS', '29600', '29601', '29602', '29603', '29604', '29605', '29606', '29610', '29611', '29612', '29613', '29614', '29615', '29616', '29620', '29621', '29622', '29623', '29624', '29625', '29626', '29630', '29631', '29632', '29633', '29634', '29635', '29636', '29640', '29641', '29642', '29643', '29644', '29645', '29646', '29650', '29651', '29652', '29653', '29654', '29655', '29656', '29660', '29661', '29662', '29663', '29664', '29665', '29666', '2967', '29680', '29681', '29682', '29689', '29690', '29699', 'E9500', 'E9501', 'E9502', 'E9503', 'E9504', 'E9505', 'E9506', 'E9507', 'E9508', 'E9509', 'E9510', 'E9511', 'E9518', 'E9520', 'E9521', 'E9528', 'E9529', 'E9530', 'E9531', 'E9538', 'E9539', 'E954', 'E9550', 'E9551', 'E9552', 'E9553', 'E9554', 'E9555', 'E9556', 'E9557', 'E9559', 'E956', 'E9570', 'E9571', 'E9572', 'E9579', 'E9580', 'E9581', 'E9582', 'E9583', 'E9584', 'E9585', 'E9586', 'E9587', 'E9588', 'E9589', 'E959'); 
run; 
  
* Collapse to enrollee level; 
proc sql; 
   create table out.allenrollees_hcc88_2008 as 
   select enrolid from out.allclaims_hcc88_2008
   group by enrolid; 
quit; 

data out.allenrollees_hcc88_2008;
   set out.allenrollees_hcc88_2008;

   famid = floor(enrolid/100); 
run; 

/* --- 1. Enrollment Info for all involved families -----------------------------------------*/; 
data out.allenrollment_88_2008; 
   if _N_=1 then do;
   declare hash ids(dataset:"out.allenrollees_hcc88_2008");
   ids.definekey('famid');
   ids.definedone();
   end;

   set in.ms_a_2008; 
   famid = floor(enrolid/100); 
   if ids.find()^=0 then delete;
run; 